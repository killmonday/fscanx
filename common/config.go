package common

import (
	"github.com/alitto/pond"
	"regexp"
	"strconv"
	"sync"
	"time"
)

var version = "1.8.3.b"
var Userdict = map[string][]string{
	"ftp":        {"ftp", "admin", "www", "web", "root", "db", "wwwroot", "data"},
	"mysql":      {"root", "mysql"},
	"mssql":      {"sa", "sql"},
	"smb":        {"administrator", "admin", "guest"},
	"rdp":        {"administrator", "admin", "guest"},
	"postgresql": {"postgres", "admin"},
	"ssh":        {"root", "admin"},
	"mongodb":    {"root", "admin"},
	"oracle":     {"sys", "system", "admin", "oracle", "test", "web", "orcl"},
}

var Passwords = []string{"123456", "12345678", "admin", "admin123", "root", "", "pass123", "pass@123", "password", "123123", "654321", "111111", "123", "1", "admin@123", "Admin@123", "admin123!@#", "{user}", "{user}1", "{user}111", "{user}123", "{user}@123", "{user}_123", "{user}#123", "{user}@111", "{user}@2019", "{user}@123#4", "P@ssw0rd!", "P@ssw0rd", "Passw0rd", "qwe123", "12345678", "test", "test123", "123qwe", "123qwe!@#", "123456789", "123321", "666666", "a123456.", "123456~a", "123456!a", "000000", "1234567890", "8888888", "!QAZ2wsx", "1qaz2wsx", "abc123", "abc123456", "1qaz@WSX", "a11111", "a12345", "Aa1234", "Aa1234.", "Aa12345", "a123456", "a123123", "Aa123123", "Aa123456", "Aa12345.", "sysadmin", "system", "1qaz!QAZ", "2wsx@WSX", "qwe123!@#", "Aa123456!", "A123456s!", "sa123456", "1q2w3e", "Charge123", "Aa123456789"}
var PluginPortMap = map[string]int{
	"ftp":         21,
	"ssh":         22,
	"findnet":     135,
	"netbiosUDP":  137,
	"netbios":     139,
	"smb":         445,
	"mssql":       1433,
	"oracle":      1521,
	"mysql":       3306,
	"rdp":         3389,
	"psql":        5432,
	"redis":       6379,
	"fcgi":        9000,
	"mem":         11211,
	"mgo":         27017,
	"ms17010":     1000001,
	"cve20200796": 1000002,
	"web":         1000003,
	"webonly":     1000003,
	"webpoc":      1000003,
	"smb2":        1000004,
	"wmiexec":     1000005,
	"all":         0,
	"portscan":    0,
	"icmp":        0,
	"main":        0,
}
var PortGroup = map[string]string{
	"ftp":         "21",
	"ssh":         "22",
	"findnet":     "135",
	"netbios":     "139",
	"smb":         "445",
	"mssql":       "1433",
	"oracle":      "1521",
	"mysql":       "3306",
	"rdp":         "3389",
	"psql":        "5432",
	"redis":       "6379",
	"fcgi":        "9000",
	"mem":         "11211",
	"mgo":         "27017",
	"ms17010":     "445",
	"cve20200796": "445",
	"service":     "21,22,135,139,445,1433,1521,3306,3389,5432,6379,9000,11211,27017",
	"db":          "1433,1521,3306,5432,6379,11211,27017",
	"web":         "80,81,82,83,84,85,86,87,88,89,90,91,92,98,99,443,800,801,808,880,888,889,1000,1010,1080,1081,1082,1099,1118,1888,2008,2020,2100,2375,2379,3000,3008,3128,3505,5555,6080,6648,6868,7000,7001,7002,7003,7004,7005,7007,7008,7070,7071,7074,7078,7080,7088,7200,7680,7687,7688,7777,7890,8000,8001,8002,8003,8004,8006,8008,8009,8010,8011,8012,8016,8018,8020,8028,8030,8038,8042,8044,8046,8048,8053,8060,8069,8070,8080,8081,8082,8083,8084,8085,8086,8087,8088,8089,8090,8091,8092,8093,8094,8095,8096,8097,8098,8099,8100,8101,8108,8118,8161,8172,8180,8181,8200,8222,8244,8258,8280,8288,8300,8360,8443,8448,8484,8800,8834,8838,8848,8858,8868,8879,8880,8881,8888,8899,8983,8989,9000,9001,9002,9008,9010,9043,9060,9080,9081,9082,9083,9084,9085,9086,9087,9088,9089,9090,9091,9092,9093,9094,9095,9096,9097,9098,9099,9100,9200,9443,9448,9800,9981,9986,9988,9998,9999,10000,10001,10002,10004,10008,10010,10250,12018,12443,14000,16080,18000,18001,18002,18004,18008,18080,18082,18088,18090,18098,19001,20000,20720,21000,21501,21502,28018,20880",
	"all":         "1-65535",
	"main":        "21,22,25,80,81,110,135,139,143,587,443,445,1433,1521,3306,5432,6379,7001,8000,8080,8089,9000,9200,11211,27017",
	"web1":        "80,81,82,83,84,85,8080,8081,443,8443,10443,25,109,110,143,389,465,995,993,445,4443,4433,9443,444,4444,7443,2443,1443,6443,4343,8008,8069,12322,8010,587,22,53,9100,21,19999,8100,23,139,1433,3306,5040,3389,5900,86,87,88,89,90,91,92,98,99,135,636,1080,3128,1022,1024,931,433,1434,1521,1522,2222,2323,22222,3307,5432,5433,6379,6380,7000,7001,7002,7003,7004,7005,7007,7008,7070,7071,7074,8000,8001,8002,8888,8085,8086,8089,9000,9999,10000,10444,11211,27017,9001,9002,2002,2087,2083,8071,7072,9071,9072,7680,2096",
	"web2":        "2199,7579,8443,5800,8834,993,3037,9001,1434,2087,41524,28222,11234,6080,6112,9391,7700,50001,30000,2598,6060,99,10050,1080,5351,12401,50004,10098,13500,9815,6504,10080,8085,3217,9000,6262,4000,2096,636,6106,2947,9111,5555,8888,6661,7003,5000,16102,12174,4679,3000,3307,6542,8081,2443,9390,20111,8180,20222,8333,90,8010,3628,2381,6667,10202,2207,2967,5038,7777,5986,4444,1521,11099,15200,13364,6082,9999,8087,2809,109,5400,6660,3780,8082,81,7070,3790,23472,7004,8400,5353,9080,2049,10444,1024,931,8095,11333,25,4343,3057,41025,17185,5632,8161,5984,9443,10051,9090,4659,8444,8002,10086,10203,10628,8222,3050,20031,6405,8014,3273,10008,7680,38080,7800,8903,8023,9002,9081,5920,2525,32913,44334,3632,2083,2604,34443,7210,8090,1433,9855,19810,5910,8503,445,45230,8008,10443,3389,3200,7879,8303,87,8020,88,46823,6905,5433,5554,3299,23943,62078,32764,5666,25025,7005,2601,92,443,40007,5250,3306,6050,10616,8028,11000,27888,139,5900,444,2103,2002,12203,7007,2533,2323,8901,12221,5168,6000,20171,8071,8080,2638,4433,25000,44818,8069,8812,50013,20034,6101,2100,5355,7021,31001,5631,4443,3500,2222,7074,83,52302,9495,26000,5247,7181,5093,6443,5560,19300,587,5521,389,9099,49152,41523,27017,1022,7144,62514,8001,5061,3128,20101,7510,91,5051,2375,110,6379,8205,8000,1443,5432,7787,143,48899,38292,12322,7000,3460,7002,7008,3817,2082,2380,7071,5520,37718,9809,10000,4322,7801,9084,9152,8100,23791,4445,9060,5601,30718,2362,5405,22,5040,80,10001,98,9200,19999,6070,7778,9072,23,50000,46824,12345,5814,14330,8880,57772,8089,27000,50504,34205,13838,89,8300,5498,12397,11211,6380,41080,3311,18881,433,2121,26122,84,7443,8030,1522,7902,86,3312,7001,8890,7770,21,9100,10162,55553,5580,82,135,465,50500,995,3690,8800,85,6502,4848,8086,22222,31099,5060,17200,6988,20010,7580,7072,28784,8899,7080,9071",
	"web3":        "2199,5800,993,3037,1434,2087,41524,28222,11234,6080,6112,50001,30000,2598,6060,99,10050,1080,5351,12401,50004,10098,13500,6504,10080,3217,6262,4000,2096,636,6106,2947,5555,6661,5000,16102,12174,4679,3000,3307,6542,2443,20111,20222,90,3628,2381,6667,10202,2207,2967,5038,5986,4444,1521,11099,15200,13364,6082,2809,109,5400,6660,3780,81,3790,23472,5353,2049,10444,1024,931,11333,25,4343,3057,41025,17185,5632,5984,10051,4659,10086,10203,10628,3050,20031,6405,3273,10008,38080,5920,2525,32913,44334,3632,2083,2604,34443,1433,19810,5910,445,45230,10443,3389,3200,87,88,46823,6905,5433,5554,3299,23943,62078,32764,5666,25025,2601,92,443,40007,5250,3306,6050,10616,11000,27888,139,5900,444,2103,2002,12203,2533,2323,12221,5168,6000,20171,2638,4433,25000,44818,50013,20034,6101,2100,5355,31001,5631,4443,3500,2222,83,52302,26000,5247,5093,6443,5560,19300,587,5521,389,49152,41523,27017,1022,62514,5061,3128,20101,91,5051,2375,110,6379,1443,5432,143,48899,38292,12322,3460,3817,2082,2380,5520,37718,10000,4322,23791,4445,5601,30718,2362,5405,22,5040,80,10001,98,19999,6070,23,50000,46824,12345,5814,14330,57772,27000,50504,34205,13838,89,5498,12397,11211,6380,41080,3311,18881,433,2121,26122,84,1522,86,3312,21,10162,55553,5580,82,135,465,50500,995,3690,85,6502,4848,22222,31099,5060,17200,6988,20010,28784,7000-9999",
}
var Outputfile = "result.txt"
var IsSave = true
var Webport = "80,81,82,83,84,85,86,87,88,89,90,91,92,98,99,443,800,801,808,880,888,889,1000,1010,1080,1081,1082,1099,1118,1888,2008,2020,2100,2375,2379,3000,3008,3128,3505,5555,6080,6648,6868,7000,7001,7002,7003,7004,7005,7007,7008,7070,7071,7074,7078,7080,7088,7200,7680,7687,7688,7777,7890,8000,8001,8002,8003,8004,8006,8008,8009,8010,8011,8012,8016,8018,8020,8028,8030,8038,8042,8044,8046,8048,8053,8060,8069,8070,8080,8081,8082,8083,8084,8085,8086,8087,8088,8089,8090,8091,8092,8093,8094,8095,8096,8097,8098,8099,8100,8101,8108,8118,8161,8172,8180,8181,8200,8222,8244,8258,8280,8288,8300,8360,8443,8448,8484,8800,8834,8838,8848,8858,8868,8879,8880,8881,8888,8899,8983,8989,9000,9001,9002,9008,9010,9043,9060,9080,9081,9082,9083,9084,9085,9086,9087,9088,9089,9090,9091,9092,9093,9094,9095,9096,9097,9098,9099,9100,9200,9443,9448,9800,9981,9986,9988,9998,9999,10000,10001,10002,10004,10008,10010,10250,12018,12443,14000,16080,18000,18001,18002,18004,18008,18080,18082,18088,18090,18098,19001,20000,20720,21000,21501,21502,28018,20880"
var DefaultPorts = "21,22,23,25,80,81,82,83,84,85,86,87,88,89,90,91,92,98,99,110,135,139,143,389,443,444,445,465,636,1080,3128,1022,1024,1193，1433,1434,1521,1522,2222,2323,22222,3306,3307,3389,5432,5433,5900,6379,6380,7000,7001,7002,7003,7004,7005,7007,7008,7070,7071,7074,8000,8001,8002,8443,8888,8080,8081,8085,8086,8089,9000,9999,10000,10443,10444,11211,27017"
var PortsArrayHasPlugin = []string{}

type HostInfo struct {
	Host    string
	Ports   string
	Url     string
	PocName []string //要测试的poc名，在PocDatas中的。仅字符串部分包含就会测试
}

type PocInfo struct {
	Target  string
	PocName string
}

var (
	PortsInput         string
	Path               string
	Scantype           string
	Command            string
	SshKey             string
	Domain             string
	Username           string
	Password           string
	Proxy              string
	TcpTimeout         int64
	WebTimeout         int64
	TmpSave            bool
	NoPing             bool
	UsePingExe         bool
	Pocinfo            PocInfo
	IsCheckPoc         bool
	DoBrute            bool
	RedisFile          string
	RedisShell         string
	Userfile           string
	Passfile           string
	HostFile           string
	PortFile           string
	PocPath            string
	PortScanThreadNum  int
	URL                string
	UrlFile            string
	Urls               []string
	NotScanPorts       string
	NoHosts            string
	SC                 string
	PortAdd            string
	UserAdd            string
	PassAdd            string
	BruteThread        int
	LiveTop            int
	Socks5Proxy        string
	Hash               string
	Hashs              []string
	HashBytes          [][]byte
	HostAndPortList    []string
	IsWmi              bool
	Noredistest        bool
	Iface              string  //own add
	PingRate           float64 //own add
	PingTimeout        int     //own add
	UseNmap            bool    //own add
	WebScanThreadNum   int     //own add
	IsScreenShot       bool    //own add
	ScanWithStdInput   bool    // 是否从标准输入读取
	AutoScanBigCidr    bool
	AutoScanProtocols  string
	AutoScanPorts      string
	AUtoScanIPLocation string
	AutoScanTcpTimeout int
)

var (
	UserAgent  = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/534.50 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/534.50"
	Accept     = "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"
	DnsLog     bool
	PocNum     int
	PocFull    bool
	CeyeDomain string
	ApiKey     string
	Cookie     string
)

var PluginTaskRateCtrlCh chan struct{} //所有插件任务并发控制
var WebScanRateCtrlCh chan struct{}    //web探测任务并发控制
var BruteTaskRateCtrlCh chan struct{}  //口令爆破任务并发控制
var AlivePortsMap sync.Map
var PoolScan *pond.WorkerPool
var NmapTotalTimeout time.Duration
var NmapSingleProbeTimeout time.Duration

// Discovered open port 8000/tcp on 222.213.125.131
var RegMasscanRunningText = regexp.MustCompile(`^Discovered.*port\s+(\d{1,5}).*on\s+(\d{1,3}(?:\.\d{1,3}){3}).*$`) // masscan运行时的输出格式
var RegMasscanOutputText = regexp.MustCompile(`^open.*\s+(\d{1,5})\s+(\d{1,3}(?:\.\d{1,3}){3}).*$`)                // masscan的 -oL输出格式

var PortsHasPlugin []string // 有专用插件的端口列表 []string{"21","22","135"."445","1433","3306","5432","6379","9200","11211","27017"...}

func init() {
	for _, port := range PluginPortMap {
		PortsHasPlugin = append(PortsHasPlugin, strconv.Itoa(port))
	}
}
